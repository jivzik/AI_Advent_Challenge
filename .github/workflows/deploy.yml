name: CI/CD to OMV Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  PROJECT_DIR: /srv/dev-disk-by-uuid-209cfe75-5f16-45e1-9e4a-ed4ac6b32755/appdata/ai-services/AI_Advent_Challenge
  COMPOSE_FILE: infra/localdev/docker-compose.yml

jobs:
  deploy:
    name: Build & Deploy
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“ Create .env file
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          cat > .env << EOF
          POSTGRES_DB=ai_memory
          POSTGRES_USER=ai_user
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          SPRING_PROFILES_ACTIVE=prod
          OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
          EOF
          echo "âœ… .env file created"

      - name: ğŸ’¾ Backup database
        working-directory: ${{ env.PROJECT_DIR }}
        continue-on-error: true
        run: |
          if docker ps -q -f name=postgres; then
            echo "ğŸ“¦ Creating database backup..."
            docker exec postgres pg_dump -U ai_user ai_memory > backup_$(date +%Y%m%d_%H%M%S).sql
            echo "âœ… Backup created"
          else
            echo "âš ï¸  Database not running, skipping backup"
          fi

      - name: ğŸ”¨ Build Docker images
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ—ï¸  Building images..."
          docker compose -f ${{ env.COMPOSE_FILE }} build --no-cache
          echo "âœ… Images built successfully"

      - name: ğŸ›‘ Stop old containers
        working-directory: ${{ env.PROJECT_DIR }}
        continue-on-error: true
        run: |
          echo "â¹ï¸  Stopping old containers..."
          docker compose -f ${{ env.COMPOSE_FILE }} down
          echo "âœ… Old containers stopped"

      - name: ğŸš€ Start new containers
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ”„ Starting new containers..."
          docker compose -f ${{ env.COMPOSE_FILE }} up -d
          echo "âœ… Containers started"

      - name: â³ Wait for services to be healthy
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "â³ Waiting for services to start..."
          sleep 30
          docker compose -f ${{ env.COMPOSE_FILE }} ps
          echo "âœ… Services started!"

      - name: ğŸ§¹ Cleanup old images
        continue-on-error: true
        run: |
          echo "ğŸ§¹ Cleaning up old Docker images..."
          docker image prune -f
          echo "âœ… Cleanup completed"

      - name: ğŸ“Š Show container status
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          echo "ğŸ“Š Container Status:"
          docker compose -f ${{ env.COMPOSE_FILE }} ps
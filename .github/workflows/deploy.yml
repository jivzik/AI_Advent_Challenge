name: ğŸš€ Deploy to OMV

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  PROJECT_DIR: /srv/dev-disk-by-uuid-209cfe75-5f16-45e1-9e4a-ed4ac6b32755/appdata/ai-services/AI_Advent_Challenge
  COMPOSE_FILE: infra/prod/docker-compose.yml

jobs:
  deploy:
    name: ğŸ¯ Deploy All Services
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“ Create .env file
        working-directory: infra/prod
        run: |
          cat > .env << EOF
          POSTGRES_DB=ai_challenge_db
          POSTGRES_USER=ai_user
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          SPRING_PROFILES_ACTIVE=prod
          OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
          GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
          EOF
          echo "âœ… .env file created"

      - name: ğŸ’¾ Backup Database
        continue-on-error: true
        run: |
          if docker ps -q -f name=ai-postgres; then
            echo "ğŸ“¦ Backing up database..."
            docker exec ai-postgres pg_dump -U ai_user ai_challenge_db > backup_$(date +%Y%m%d_%H%M%S).sql 2>/dev/null || true
            echo "âœ… Backup created"
          fi

      - name: ğŸ”¨ Build Docker Images
        run: |
          echo "ğŸ—ï¸  Building all images..."
          docker compose -f ${{ env.COMPOSE_FILE }} build
          echo "âœ… Build complete"

      - name: ğŸ›‘ Stop Old Containers
        continue-on-error: true
        run: |
          echo "â¹ï¸  Stopping old containers..."
          docker compose -f ${{ env.COMPOSE_FILE }} down
          echo "âœ… Stopped"

      - name: ğŸš€ Start New Containers
        run: |
          echo "ğŸ”„ Starting all services..."
          docker compose -f ${{ env.COMPOSE_FILE }} up -d
          echo "âœ… All services started!"

      - name: â³ Wait for Health Checks
        run: |
          echo "â³ Waiting 60 seconds for services to become healthy..."
          sleep 60

      - name: ğŸ§ª Test Services
        continue-on-error: true
        run: |
          echo "ğŸ§ª Testing services..."
          curl -f http://localhost:8081/actuator/health || echo "âŒ MCP Server not ready"
          curl -f http://localhost:8084/actuator/health || echo "âŒ OpenRouter not ready"
          curl -f http://localhost:8086/actuator/health || echo "âŒ RAG Server not ready"
          curl -f http://localhost:8088/actuator/health || echo "âŒ Support not ready"
          curl -f http://localhost:8089/actuator/health || echo "âŒ Team not ready"
          curl -f http://localhost:8080/health || echo "âŒ Nginx not ready"
          echo "âœ… Health checks complete"

      - name: ğŸ“Š Show Final Status
        run: |
          echo "ğŸ“Š Final Container Status:"
          docker compose -f ${{ env.COMPOSE_FILE }} ps

      - name: ğŸ§¹ Cleanup Old Images
        continue-on-error: true
        run: |
          echo "ğŸ§¹ Cleaning up..."
          docker image prune -f
          echo "âœ… Cleanup done"

      - name: ğŸ‰ Deployment Complete
        run: |
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL! ğŸ‰"
          echo "Frontend: http://YOUR_IP:8080"
          echo "Services: Ports 8081-8089"